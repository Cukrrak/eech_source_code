// 
// 	 Enemy Engaged RAH-66 Comanche Versus KA-52 Hokum
// 	 Copyright (C) 2000 Empire Interactive (Europe) Ltd,
// 	 677 High Road, North Finchley, London N12 0DA
// 
// 	 Please see the document LICENSE.TXT for the full licence agreement
// 
// 2. LICENCE
//  2.1 	
//  	Subject to the provisions of this Agreement we now grant to you the 
//  	following rights in respect of the Source Code:
//   2.1.1 
//   	the non-exclusive right to Exploit  the Source Code and Executable 
//   	Code on any medium; and 
//   2.1.2 
//   	the non-exclusive right to create and distribute Derivative Works.
//  2.2 	
//  	Subject to the provisions of this Agreement we now grant you the
// 	following rights in respect of the Object Code:
//   2.2.1 
// 	the non-exclusive right to Exploit the Object Code on the same
// 	terms and conditions set out in clause 3, provided that any
// 	distribution is done so on the terms of this Agreement and is
// 	accompanied by the Source Code and Executable Code (as
// 	applicable).
// 
// 3. GENERAL OBLIGATIONS
//  3.1 
//  	In consideration of the licence granted in clause 2.1 you now agree:
//   3.1.1 
// 	that when you distribute the Source Code or Executable Code or
// 	any Derivative Works to Recipients you will also include the
// 	terms of this Agreement;
//   3.1.2 
// 	that when you make the Source Code, Executable Code or any
// 	Derivative Works ("Materials") available to download, you will
// 	ensure that Recipients must accept the terms of this Agreement
// 	before being allowed to download such Materials;
//   3.1.3 
// 	that by Exploiting the Source Code or Executable Code you may
// 	not impose any further restrictions on a Recipient's subsequent
// 	Exploitation of the Source Code or Executable Code other than
// 	those contained in the terms and conditions of this Agreement;
//   3.1.4 
// 	not (and not to allow any third party) to profit or make any
// 	charge for the Source Code, or Executable Code, any
// 	Exploitation of the Source Code or Executable Code, or for any
// 	Derivative Works;
//   3.1.5 
// 	not to place any restrictions on the operability of the Source 
// 	Code;
//   3.1.6 
// 	to attach prominent notices to any Derivative Works stating
// 	that you have changed the Source Code or Executable Code and to
// 	include the details anddate of such change; and
//   3.1.7 
//   	not to Exploit the Source Code or Executable Code otherwise than
// 	as expressly permitted by  this Agreement.
// 



/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "project.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define DEBUG_MODULE 0

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct VIEW_SEARCH
{
	entity_sides
		players_side;

	view_groups
		group;

	view_sides
		side;

	view_categories
		category;

	view_types
		type;

	float
		sqr_range;
};

typedef struct VIEW_SEARCH view_search;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define	VIEW_RANGE_ALL			((float) (1000000.0 * 1000000.0))
#define	VIEW_RANGE_5KM			((float) (5000.0 * 5000.0))
#define	VIEW_RANGE_10KM		((float) (10000.0 * 10000.0))
#define	VIEW_RANGE_50KM		((float) (50000.0 * 50000.0))
#define	VIEW_RANGE_100KM		((float) (100000.0 * 100000.0))

#define view_range_valid(RANGE)		\
(												\
	((RANGE) == VIEW_RANGE_ALL) ||	\
	((RANGE) == VIEW_RANGE_5KM) ||	\
	((RANGE) == VIEW_RANGE_10KM) ||	\
	((RANGE) == VIEW_RANGE_50KM) ||	\
	((RANGE) == VIEW_RANGE_100KM)		\
)

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int
	initialised = FALSE,
	display_enabled;

static float
	side_list_width,
	category_list_width,
	type_list_width,
	object_list_width,
	view_menu_x_start;

static int
	group_counters[NUM_VIEW_GROUPS],
	side_counters[NUM_VIEW_SIDES],
	category_counters[NUM_VIEW_CATEGORIES],
	type_counters[NUM_VIEW_TYPES];

static view_search
		search;

static float
	refresh_timer;

static entity
	*entity_being_destroyed;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define REFRESH_PERIOD	((float) (5.0))

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define VIEW_MENU_TITLE_FONT	(UI_FONT_ARIAL_22)

#define VIEW_MENU_FONT			(UI_FONT_ARIAL_16)

#define VIEW_MENU_Y_MIN			((float) 0.075)
#define VIEW_MENU_Y_MAX			((float) 0.85)

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// VIEW MENU NAMES
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static char
	*group_names[NUM_VIEW_GROUPS] =
	{
		"All",									// VIEW_GROUP_ALL
		"Wingmen",								// VIEW_GROUP_WINGMEN
		"Players",								// VIEW_GROUP_PLAYERS
		"Available gunships",				// VIEW_GROUP_AVAILABLE_GUNSHIPS
	};

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static char
	*side_names[] =
	{
		"All",									// VIEW_SIDE_ALL
		"Allied",								// VIEW_SIDE_ALLIED
		"Enemy",									// VIEW_SIDE_ENEMY
	};

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static char
	*category_names[] =
	{
		"All",									// VIEW_CATEGORY_ALL
		"Combat Helicopters",				// VIEW_CATEGORY_COMBAT_HELICOPTERS
		"Transport Helicopters",			// VIEW_CATEGORY_TRANSPORT_HELICOPTERS
		"Combat Aircraft",					// VIEW_CATEGORY_COMBAT_AIRCRAFT
		"Transport Aircraft",				// VIEW_CATEGORY_TRANSPORT_AIRCRAFT
		"Combat Vehicles",					// VIEW_CATEGORY_COMBAT_VEHICLES
		"Artillery",							// VIEW_CATEGORY_ARTILLERY
		"Air Defence Units",					// VIEW_CATEGORY_AIR_DEFENCE_UNITS
		"Transport Vehicles",				// VIEW_CATEGORY_TRANSPORT_VEHICLES
		"Infantry",								// VIEW_CATEGORY_INFANTRY
		"Warships",								// VIEW_CATEGORY_WARSHIPS
	};

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static char
	*type_names[] =
	{
		"All",									// VIEW_TYPE_ALL
		"AH-1T SeaCobra",						// VIEW_TYPE_AH1T_SEACOBRA
		"AH-1W SuperCobra",					// VIEW_TYPE_AH1W_SUPERCOBRA
		"AH-64A Apache",						// VIEW_TYPE_AH64A_APACHE
		"AH-64D Apache Longbow",			// VIEW_TYPE_AH64D_APACHE_LONGBOW
		"CH-46E Sea Knight",					// VIEW_TYPE_CH46E_SEA_KNIGHT
		"Ka-29 Helix B",						// VIEW_TYPE_KA29_HELIX_B
		"Ka-50 Hokum",							// VIEW_TYPE_KA50_HOKUM
		"Ka-52 Hokum B",						// VIEW_TYPE_KA52_HOKUM_B
		"Mi-24D Hind",							// VIEW_TYPE_MI24D_HIND
		"Mi-28N Havoc B",						// VIEW_TYPE_MI28N_HAVOC_B
		"MV-22 Osprey",						// VIEW_TYPE_MV22_OSPREY
		"OH-58D Kiowa Warrior",				// VIEW_TYPE_OH58D_KIOWA_WARRIOR
		"RAH-66 Comanche",					// VIEW_TYPE_RAH66_COMANCHE
		"UH-60 Black Hawk",					// VIEW_TYPE_UH60_BLACK_HAWK
		"CH-3 Jolly Green Giant",			// VIEW_TYPE_CH3_JOLLY_GREEN_GIANT
		"CH-47D Chinook",						// VIEW_TYPE_CH47D_CHINOOK
		"CH-53E Super Stallion",			// VIEW_TYPE_CH53E_SUPER_STALLION
		"Mi-6 Hook",							// VIEW_TYPE_MI6_HOOK
		"Mi-17 Hip",							// VIEW_TYPE_MI17_HIP
		"A-10A Thunderbolt",					// VIEW_TYPE_A10A_THUNDERBOLT
		"AV-8B Harrier",						// VIEW_TYPE_AV8B_HARRIER
		"F-16 Fighting Falcon",				// VIEW_TYPE_F16_FIGHTING_FALCON
		"F/A-18 Hornet",						// VIEW_TYPE_FA18_HORNET
		"MiG-29 Fulcrum",						// VIEW_TYPE_MIG29_FULCRUM
		"Su-25 Frogfoot",						// VIEW_TYPE_SU25_FROGFOOT
		"Su-33 Flanker",						// VIEW_TYPE_SU33_FLANKER
		"Yak-41 Freestyle",					// VIEW_TYPE_YAK41_FREESTYLE
		"An-12B Cub",							// VIEW_TYPE_AN12B_CUB
		"C-17 Globemaster III",				// VIEW_TYPE_C17_GLOBEMASTER_III
		"C-130J Hercules II",				// VIEW_TYPE_C130J_HERCULES_II
		"Il-76MD Candid-B",					// VIEW_TYPE_IL76MD_CANDID_B
		"BMP-2",									// VIEW_TYPE_BMP2
		"BMP-3",									// VIEW_TYPE_BMP3
		"BRDM-2",								// VIEW_TYPE_BRDM2
		"BTR-80",								// VIEW_TYPE_BTR80
		"M1A2 Abrams",							// VIEW_TYPE_M1A2_ABRAMS
		"M2A2 Bradley",						// VIEW_TYPE_M2A2_BRADLEY
		"M113A2",								// VIEW_TYPE_M113A2
		"M1025 HumVee",						// VIEW_TYPE_M1025_HUMVEE
		"T-80U",									// VIEW_TYPE_T80U
		"2S19",									// VIEW_TYPE_2S19
		"BM-21 Grad",							// VIEW_TYPE_BM21_GRAD
		"M109A2",								// VIEW_TYPE_M109A2
		"M270 MLRS",							// VIEW_TYPE_M270_MLRS
		"M48A1 Chaparral",					// VIEW_TYPE_M48A1_CHAPARRAL
		"M163 Vulcan",							// VIEW_TYPE_M163_VULCAN
		"M1037 Avenger",						// VIEW_TYPE_M1037_AVENGER
		"SA-13 Gopher",						// VIEW_TYPE_SA13_GOPHER
		"SA-19 Grison",						// VIEW_TYPE_SA19_GRISON
		"M978 HEMTT",							// VIEW_TYPE_M978_HEMTT
		"M923A1 Big Foot",					// VIEW_TYPE_M923A1_BIG_FOOT
		"M998 HumVee",							// VIEW_TYPE_M998_HUMVEE
		"UAZ-469B",								// VIEW_TYPE_UAZ469B
		"Ural-4320",							// VIEW_TYPE_URAL_4320
		"Ural Fuel Tanker",					// VIEW_TYPE_URAL_FUEL_TANKER
		"Infantry",								// VIEW_TYPE_INFANTRY
		"Infantry with SAM",					// VIEW_TYPE_INFANTRY_WITH_SAM
		"Aist Class",							// VIEW_TYPE_AIST_CLASS
		"Kiev Class",							// VIEW_TYPE_KIEV_CLASS
		"Krivak II Class",					// VIEW_TYPE_KRIVAK_II_CLASS
		"LCU",									// VIEW_TYPE_LCU
		"LCAC",									// VIEW_TYPE_LCAC
		"OHP Class",							// VIEW_TYPE_OLIVER_HAZARD_PERRY_CLASS
		"Tarawa Class",						// VIEW_TYPE_TARAWA_CLASS
	};

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// CHECK ENTITY MATCHES VIEW SEARCH PARAMETERS
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_match_view_search_group (entity* en)
{
	ASSERT (en);

	ASSERT (view_group_valid (search.group));

	switch (search.group)
	{
		////////////////////////////////////////
		case VIEW_GROUP_ALL:
		////////////////////////////////////////
		{
			return (TRUE);

			break;
		}
		////////////////////////////////////////
		case VIEW_GROUP_WINGMEN:
		////////////////////////////////////////
		{
			entity
				*gunship,
				*parent;

			gunship = get_gunship_entity ();

			if (gunship)
			{
				parent = get_local_entity_parent (gunship, LIST_TYPE_MEMBER);

				if (parent)
				{
					if (parent == get_local_entity_parent (en, LIST_TYPE_MEMBER))
					{
						return (TRUE);
					}
				}
			}

			return (FALSE);

			break;
		}
		////////////////////////////////////////
		case VIEW_GROUP_PLAYERS:
		////////////////////////////////////////
		{
			return (get_local_entity_int_value (en, INT_TYPE_PLAYER) != ENTITY_PLAYER_AI);

			break;
		}
		////////////////////////////////////////
		case VIEW_GROUP_AVAILABLE_GUNSHIPS:
		////////////////////////////////////////
		{
			ASSERT (get_pilot_entity ());

			if (get_local_entity_suitable_for_player (en, get_pilot_entity ()))
			{
				if (get_local_entity_primary_task (en))
				{
					return (TRUE);
				}
			}

			return (FALSE);

			break;
		}
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_match_view_search_side (entity* en)
{
	ASSERT (en);

	ASSERT (view_side_valid (search.side));

	if (search.players_side == ENTITY_SIDE_NEUTRAL)
	{
		return (TRUE);
	}

	switch (search.side)
	{
		////////////////////////////////////////
		case VIEW_SIDE_ALL:
		////////////////////////////////////////
		{
			return (TRUE);

			break;
		}
		////////////////////////////////////////
		case VIEW_SIDE_ALLIED:
		////////////////////////////////////////
		{
			return (get_local_entity_int_value (en, INT_TYPE_SIDE) == search.players_side);

			break;
		}
		////////////////////////////////////////
		case VIEW_SIDE_ENEMY:
		////////////////////////////////////////
		{
			return (get_local_entity_int_value (en, INT_TYPE_SIDE) != search.players_side);

			break;
		}
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_match_view_search_category (entity* en)
{
	ASSERT (en);

	ASSERT (view_category_valid (search.category));

	return ((search.category == VIEW_CATEGORY_ALL) || (search.category == get_local_entity_int_value (en, INT_TYPE_VIEW_CATEGORY)));
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_match_view_search_type (entity* en)
{
	ASSERT (en);

	ASSERT (view_type_valid (search.type));

	return ((search.type == VIEW_TYPE_ALL) || (search.type == get_local_entity_int_value (en, INT_TYPE_VIEW_TYPE)));
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_match_view_search_range (entity *en)
{
	vec3d
		*p1,
		*p2;

	ASSERT (en);

	ASSERT (view_range_valid (search.sqr_range));

	if (!get_gunship_entity ())
	{
		return (TRUE);
	}

	p1 = get_local_entity_vec3d_ptr (get_gunship_entity (), VEC3D_TYPE_POSITION);

	p2 = get_local_entity_vec3d_ptr (en, VEC3D_TYPE_POSITION);

	return (get_sqr_2d_range (p1, p2) < search.sqr_range);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_match_view_search (entity *en)
{
	ASSERT (en);

	if (en == entity_being_destroyed)
	{
		return (FALSE);
	}

	if (get_match_view_search_group (en))
	{
		if (get_match_view_search_range (en))
		{
			if (get_match_view_search_side (en))
			{
				if (get_match_view_search_category (en))
				{
					if (get_match_view_search_type (en))
					{
						return (TRUE);
					}
				}
			}
		}
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static entity *get_first_view_search_match (void)
{
	entity
		*en;

	ASSERT (get_camera_entity ());

	en = get_local_entity_first_child (get_camera_entity (), LIST_TYPE_VIEW);

	while (en)
	{
		if (get_match_view_search (en))
		{
			return (en);
		}

		en = get_local_entity_child_succ (en, LIST_TYPE_VIEW);
	}

	return (NULL);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static entity *get_next_view_search_match (entity *en)
{
	ASSERT (en);

	//
	// the starting entity must be a valid match so the search will always terminate
	//

	debug_assert (get_match_view_search (en));

	en = get_local_entity_child_succ_circular (en, LIST_TYPE_VIEW);

	while (!get_match_view_search (en))
	{
		en = get_local_entity_child_succ_circular (en, LIST_TYPE_VIEW);
	}

	return (en);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static entity *get_previous_view_search_match (entity *en)
{
	ASSERT (en);

	//
	// the starting entity must be a valid match so the search will always terminate
	//

	debug_assert (get_match_view_search (en));

	en = get_local_entity_child_pred_circular (en, LIST_TYPE_VIEW);

	while (!get_match_view_search (en))
	{
		en = get_local_entity_child_pred_circular (en, LIST_TYPE_VIEW);
	}

	return (en);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// GET ENTITY VIEW SEARCH VALUES
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static view_sides get_local_entity_view_side (entity* en)
{
	ASSERT (en);

	if (search.players_side == ENTITY_SIDE_NEUTRAL)
	{
		return (VIEW_SIDE_ALL);
	}

	if (get_local_entity_int_value (en, INT_TYPE_SIDE) == search.players_side)
	{
		return (VIEW_SIDE_ALLIED);
	}

	return (VIEW_SIDE_ENEMY);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static view_categories get_local_entity_view_category (entity *en)
{
	ASSERT (en);

	return (get_local_entity_int_value (en, INT_TYPE_VIEW_CATEGORY));
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static view_types get_local_entity_view_type (entity *en)
{
	ASSERT (en);

	return (get_local_entity_int_value (en, INT_TYPE_VIEW_TYPE));
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// BUILD VIEW MENU
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void build_view_menu (void)
{
	entity
		*en;

	view_sides
		side;

	view_categories
		category;

	view_types
		type;

	refresh_timer = REFRESH_PERIOD;

	////////////////////////////////////////
	//
	// initialise
	//
	////////////////////////////////////////

	memset (group_counters, 0, sizeof (group_counters));

	memset (side_counters, 0, sizeof (side_counters));

	memset (category_counters, 0, sizeof (category_counters));

	memset (type_counters, 0, sizeof (type_counters));

	////////////////////////////////////////
	//
	// build view menu
	//
	////////////////////////////////////////

	en = get_local_entity_first_child (get_camera_entity (), LIST_TYPE_VIEW);

	while (en)
	{
		if (get_match_view_search_group (en))
		{
			group_counters[VIEW_GROUP_ALL]++;

			if (search.group != VIEW_GROUP_ALL)
			{
				group_counters[search.group]++;
			}

			if (get_match_view_search_range (en))
			{
				side = get_local_entity_view_side (en);

				side_counters[VIEW_SIDE_ALL]++;

				if (side != VIEW_SIDE_ALL)
				{
					side_counters[side]++;
				}

				if ((search.side == VIEW_SIDE_ALL) || (side == search.side))
				{
					category = get_local_entity_view_category (en);

					category_counters[VIEW_CATEGORY_ALL]++;

					category_counters[category]++;

					if ((search.category == VIEW_CATEGORY_ALL) || (category == search.category))
					{
						type = get_local_entity_view_type (en);

						type_counters[VIEW_TYPE_ALL]++;

						type_counters[type]++;
					}
				}
			}
		}

		en = get_local_entity_child_succ (en, LIST_TYPE_VIEW);
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static entity *get_widen_view_search_match (entity *this_entity)
{
	entity
		*en;

	//
	// if this_entity is given then only try to match this_entity
	//

	if (this_entity)
	{
		if (get_match_view_search (this_entity))
		{
			return (this_entity);
		}
		else
		{
			return (NULL);
		}
	}

	//
	// try to match the external view entity
	//

	en = get_external_view_entity ();

	if (en)
	{
		if (get_match_view_search (en))
		{
			return (en);
		}
	}

	//
	// try to match any entity
	//

	return (get_first_view_search_match ());
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static entity *widen_view_search_params (entity *this_entity)
{
	entity
		*found;

	view_sides
		side;

	view_categories
		category;

	view_types
		type;

	//
	// unmodified search params
	//

	build_view_menu ();

	if (found = get_widen_view_search_match (this_entity))
	{
		return (found);
	}

	//
	// widen range
	//

	if (search.sqr_range == VIEW_RANGE_5KM)
	{
		search.sqr_range = VIEW_RANGE_10KM;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	if (search.sqr_range == VIEW_RANGE_10KM)
	{
		search.sqr_range = VIEW_RANGE_50KM;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	if (search.sqr_range == VIEW_RANGE_50KM)
	{
		search.sqr_range = VIEW_RANGE_100KM;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	if (search.sqr_range == VIEW_RANGE_100KM)
	{
		search.sqr_range = VIEW_RANGE_ALL;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	//
	// widen group
	//

	if (search.group != VIEW_GROUP_ALL)
	{
		search.group = VIEW_GROUP_ALL;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	//
	// widen type
	//

	if (search.type != VIEW_TYPE_ALL)
	{
		//
		// try this_entity's type
		//

		if (this_entity)
		{
			type = get_local_entity_view_type (this_entity);

			if (search.type != type)
			{
				search.type = type;

				build_view_menu ();

				if (found = get_widen_view_search_match (this_entity))
				{
					return (found);
				}
			}
		}

		//
		// try all type's
		//

		search.type = VIEW_TYPE_ALL;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	if (search.category != VIEW_CATEGORY_ALL)
	{
		//
		// try this_entity's category
		//

		if (this_entity)
		{
			category = get_local_entity_view_category (this_entity);

			if (search.category != category)
			{
				search.category = category;

				build_view_menu ();

				if (found = get_widen_view_search_match (this_entity))
				{
					return (found);
				}
			}
		}

		//
		// try all categories
		//

		search.category = VIEW_CATEGORY_ALL;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	if (search.side != VIEW_SIDE_ALL)
	{
		//
		// try this_entity's side
		//

		if (this_entity)
		{
			side = get_local_entity_view_side (this_entity);

			if (search.side != side)
			{
				search.side = side;

				build_view_menu ();

				if (found = get_widen_view_search_match (this_entity))
				{
					return (found);
				}
			}
		}

		//
		// try all sides
		//

		search.side = VIEW_SIDE_ALL;

		build_view_menu ();

		if (found = get_widen_view_search_match (this_entity))
		{
			return (found);
		}
	}

	debug_fatal ("widen_view_search_params - failed to find a match");

	return (NULL);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void rebuild_view_menu (void)
{
	entity
		*en;

	en = widen_view_search_params (NULL);

	set_raw_external_view_entity (en);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// GET NEXT AND PREVIOUS VALID ARRAY INDEX
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_next_valid_array_index (int array[], int index, int max_index)
{
	int
		i;

	ASSERT (array);

	ASSERT (index >= 0);

	ASSERT (max_index > index);

	ASSERT (array[index] > 0);

	i = index;

	while (TRUE)
	{
		i++;

		if (i == max_index)
		{
			i = 0;
		}

		if (array[i] > 0)
		{
			index = i;

			break;
		}
	}

	return (index);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static int get_previous_valid_array_index (int array[], int index, int max_index)
{
	int
		i;

	ASSERT (array);

	ASSERT (index >= 0);

	ASSERT (max_index > index);

	ASSERT (array[index] > 0);

	i = index;

	while (TRUE)
	{
		i--;

		if (i < 0)
		{
			i = max_index - 1;
		}

		if (array[i] > 0)
		{
			index = i;

			break;
		}
	}

	return (index);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// INITIALISE VIEW MENU
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void initialise_view_menu (void)
{
	ASSERT (!initialised);

	ASSERT (get_pilot_entity ());

	ASSERT (get_camera_entity ());

	ASSERT (get_local_entity_first_child (get_camera_entity (), LIST_TYPE_VIEW));

	initialised = TRUE;

	display_enabled = FALSE;

	memset (group_counters, 0, sizeof (group_counters));

	memset (side_counters, 0, sizeof (side_counters));

	memset (category_counters, 0, sizeof (category_counters));

	memset (type_counters, 0, sizeof (type_counters));

	search.players_side = get_local_entity_int_value (get_pilot_entity (), INT_TYPE_SIDE);

	ASSERT (search.players_side != ENTITY_SIDE_NEUTRAL);

	search.group = VIEW_GROUP_ALL;

	search.side = VIEW_SIDE_ALL;

	search.category = VIEW_CATEGORY_ALL;

	search.type = VIEW_TYPE_ALL;

	search.sqr_range = VIEW_RANGE_ALL;

	refresh_timer = REFRESH_PERIOD;

	entity_being_destroyed = NULL;

	build_view_menu ();

	if (!get_external_view_entity ())
	{
		entity
			*en;

		en = get_gunship_entity ();

		if (!en)
		{
			en = get_first_view_search_match ();
		}

		debug_assert (en);

		debug_assert (get_match_view_search (en));

		set_raw_external_view_entity (en);
	}

	////////////////////////////////////////
	//
	// pre-calc view menu list widths
	//
	////////////////////////////////////////

	{
		int
			i;

		set_ui_font_type (VIEW_MENU_FONT);

		side_list_width = ui_get_string_length ("Side: (Ctrl F5)");

		for (i = 0; i < NUM_VIEW_SIDES; i++)
		{
			side_list_width = max (side_list_width, ui_get_string_length (side_names[i]));
		}

		side_list_width /= full_screen_width;

		side_list_width += 0.025;

		////////////////////////////////////////

		category_list_width = ui_get_string_length ("Category: (Ctrl F6)");

		for (i = 0; i < NUM_VIEW_CATEGORIES; i++)
		{
			category_list_width = max (category_list_width, ui_get_string_length (category_names[i]));
		}

		category_list_width /= full_screen_width;

		category_list_width += 0.025;

		////////////////////////////////////////

		type_list_width = ui_get_string_length ("Type: (Ctrl F7)");

		for (i = 0; i < NUM_VIEW_TYPES; i++)
		{
			type_list_width = max (type_list_width, ui_get_string_length (type_names[i]));
		}

		type_list_width /= full_screen_width;

		type_list_width += 0.025;

		////////////////////////////////////////

		object_list_width = ui_get_string_length ("Object (1234 objects): (Ctrl F8)");

		for (i = 0; i < NUM_ENTITY_SUB_TYPE_AIRCRAFT; i++)
		{
			object_list_width = max (object_list_width, ui_get_string_length (aircraft_database[i].full_name));
		}

		for (i = 0; i < NUM_ENTITY_SUB_TYPE_VEHICLES; i++)
		{
			object_list_width = max (object_list_width, ui_get_string_length (vehicle_database[i].full_name));
		}

		object_list_width /= full_screen_width;

		////////////////////////////////////////

		view_menu_x_start = 1.0 - (side_list_width + category_list_width + type_list_width + object_list_width);

		if (view_menu_x_start < 0.0)
		{
			view_menu_x_start = 0.0;
		}

		view_menu_x_start *= 0.5;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void deinitialise_view_menu (void)
{
	ASSERT (initialised);

	initialised = FALSE;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// VALIDATE
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void validate_view_menu (void)
{
	ASSERT (initialised);

	ASSERT (get_camera_entity ());

	ASSERT (get_local_entity_first_child (get_camera_entity (), LIST_TYPE_VIEW));

	ASSERT (entity_side_valid (search.players_side));

	ASSERT (view_group_valid (search.group));

	ASSERT (view_side_valid (search.side));

	ASSERT (view_category_valid (search.category));

	ASSERT (view_type_valid (search.type));

	ASSERT (view_range_valid (search.sqr_range));

	////////////////////////////////////////
	//
	// detect invalid external view entity (ie an 'available' gunship gets destroyed)
	//
	////////////////////////////////////////
	{
		entity
			*en;

		en = get_external_view_entity ();

		if (en)
		{
			if (!get_match_view_search (en))
			{
				//
				// widen search parameters so that the object is still visible
				//

				search.group = VIEW_GROUP_ALL;

				search.side = VIEW_SIDE_ALL;

				search.category = VIEW_CATEGORY_ALL;

				search.type = VIEW_TYPE_ALL;

				search.sqr_range = VIEW_RANGE_ALL;

				rebuild_view_menu ();
			}
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// UPDATE VIEW MENU
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void update_view_menu (void)
{
	validate_view_menu ();

	refresh_timer -= get_delta_time ();

	if (refresh_timer < 0.0)
	{
		rebuild_view_menu ();
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// DISPLAY VIEW MENU
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void display_array_list
(
	int array_counters[],
	char *array_names[],
	int index,
	int max_index,
	float x,
	float y,
	float y_add,
	int display_list_length
)
{
	int
		i,
		first,
		page,
		num_pages,
		count,
		num_list_items;

	ASSERT (array_counters);

	ASSERT (array_names);

	ASSERT (index >= 0);

	ASSERT (max_index > index);

	ASSERT (display_list_length > 0);

	num_list_items = 0;

	for (i = 0; i < max_index; i++)
	{
		if (array_counters[i] > 0)
		{
			num_list_items++;
		}
	}

	ASSERT (num_list_items > 0);

	page = 1;

	num_pages = num_list_items / display_list_length;

	if ((num_list_items % display_list_length) > 0)
	{
		num_pages++;
	}

	first = 0;

	if (num_list_items > display_list_length)
	{
		count = 0;

		i = first;

		while (i < max_index)
		{
			if (array_counters[i] > 0)
			{
				if (count == display_list_length)
				{
					page++;

					first = i;

					count = 0;
				}

				count++;

				if (i == index)
				{
					break;
				}
			}

			i++;
		}
	}

	if (page > 1)
	{
		set_ui_font_colour (ext_col_list_item_available);

		ui_display_text ("Previous ...", x, y);
	}

	y += y_add;

	count = display_list_length;

	i = first;

	while (i < max_index)
	{
		if (array_counters[i] > 0)
		{
			if (i == index)
			{
				set_ui_font_colour (ext_col_list_item_selected);
			}
			else
			{
				set_ui_font_colour (ext_col_list_item_available);
			}

			ui_display_text (array_names[i], x, y);

			y += y_add;

			count--;

			if (count == 0)
			{
				break;
			}
		}

		i++;
	}

	if (page < num_pages)
	{
		set_ui_font_colour (ext_col_list_item_available);

		ui_display_text ("Next ...", x, y);
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static void display_object_list (float x, float y, float y_add, int num_list_items, int display_list_length)
{
	entity
		*en,
		*first;

	int
		page,
		num_pages,
		count;

	ASSERT (num_list_items > 0);

	ASSERT (display_list_length > 0);

	page = 1;

	num_pages = num_list_items / display_list_length;

	if ((num_list_items % display_list_length) > 0)
	{
		num_pages++;
	}

	first = get_local_entity_first_child (get_camera_entity (), LIST_TYPE_VIEW);

	if (num_list_items > display_list_length)
	{
		count = 0;

		en = first;

		while (en)
		{
			if (get_match_view_search (en))
			{
				if (count == display_list_length)
				{
					page++;

					first = en;

					count = 0;
				}

				count++;

				if (en == get_external_view_entity ())
				{
					break;
				}
			}

			en = get_local_entity_child_succ (en, LIST_TYPE_VIEW);
		}
	}

	if (page > 1)
	{
		set_ui_font_colour (ext_col_list_item_available);

		ui_display_text ("Previous ...", x, y);
	}

	y += y_add;

	count = display_list_length;

	en = first;

	while (en)
	{
		if (get_match_view_search (en))
		{
			if (en == get_external_view_entity ())
			{
				set_ui_font_colour (ext_col_list_item_selected);
			}
			else
			{
				set_ui_font_colour (ext_col_list_item_available);
			}

			ui_display_text (get_local_entity_string (en, STRING_TYPE_FULL_NAME), x, y);

			y += y_add;

			count--;

			if (count == 0)
			{
				break;
			}
		}

		en = get_local_entity_child_succ (en, LIST_TYPE_VIEW);
	}

	if (page < num_pages)
	{
		set_ui_font_colour (ext_col_list_item_available);

		ui_display_text ("Next ...", x, y);
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static char *get_view_range_string (float sqr_range)
{
	ASSERT (view_range_valid (sqr_range));

	if (sqr_range == VIEW_RANGE_ALL)
	{
		return ("All");
	}
	else if (sqr_range == VIEW_RANGE_5KM)
	{
		return ("5Km");
	}
	else if (sqr_range == VIEW_RANGE_10KM)
	{
		return ("10Km");
	}
	else if (sqr_range == VIEW_RANGE_50KM)
	{
		return ("50Km");
	}
	else if (sqr_range == VIEW_RANGE_100KM)
	{
		return ("100Km");
	}

	return ("Invalid");
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void display_view_menu (void)
{
	char
		s[200];

	float
		x,
		y,
		y_min,
		y_max,
		y_add,
		y_list,
		width;

	int
		display_list_length;

	if (!display_enabled)
	{
		return;
	}

	validate_view_menu ();

	set_viewport (full_screen_x_min, full_screen_y_min, full_screen_x_max, full_screen_y_max);

	y_min = full_screen_height * VIEW_MENU_Y_MIN;

	y_max = full_screen_height * VIEW_MENU_Y_MAX;

	////////////////////////////////////////
	//
	// backdrop
	//
	////////////////////////////////////////

	{
		vertex
			quad[4];

		real_colour
			colour,
			specular;

		float
			x_min,
			y_min,
			x_max,
			y_max;

		x_min = full_screen_width * view_menu_x_start * 0.5;
		y_min = full_screen_height * (VIEW_MENU_Y_MIN - 0.025);
		x_max = full_screen_width - x_min;
		y_max = full_screen_height * (VIEW_MENU_Y_MAX + 0.0125);

		ASSERT ((x_min >= full_screen_x_min) && (x_min <= full_screen_x_max));
		ASSERT ((y_min >= full_screen_y_min) && (y_min <= full_screen_y_max));
		ASSERT ((x_max >= full_screen_x_min) && (x_max <= full_screen_x_max));
		ASSERT ((y_max >= full_screen_y_min) && (y_max <= full_screen_y_max));

		colour.red = 0;
		colour.green = 0;
		colour.blue = 0;
		colour.alpha = 64;

		specular.red = 0;
		specular.green = 0;
		specular.blue = 0;
		specular.alpha = 255;

		set_d3d_alpha_fog_zbuffer (TRUE, FALSE, FALSE, FALSE);

		set_d3d_plain_renderstate ();

		set_d3d_culling (FALSE);

		quad[0].i = x_min;
		quad[0].j = y_min;
		quad[0].z = 0.5;
		quad[0].q = 0.5;
		quad[0].next_vertex = &quad[1];

		quad[1].i = x_max;
		quad[1].j = y_min;
		quad[1].z = 0.5;
		quad[1].q = 0.5;
		quad[1].next_vertex = &quad[2];

		quad[2].i = x_max;
		quad[2].j = y_max;
		quad[2].z = 0.5;
		quad[2].q = 0.5;
		quad[2].next_vertex = &quad[3];

		quad[3].i = x_min;
		quad[3].j = y_max;
		quad[3].z = 0.5;
		quad[3].q = 0.5;
		quad[3].next_vertex = NULL;

		draw_wbuffered_plain_polygon (quad, colour, specular);
	}

	////////////////////////////////////////
	//
	// title
	//
	////////////////////////////////////////

	set_ui_font_type (VIEW_MENU_TITLE_FONT);

	y_add = ui_get_font_height ();

	x = full_screen_x_mid - (ui_get_string_length (get_trans ("Select Object To View")) * 0.5);
	y = y_min;

	set_ui_font_colour (ext_col_menu_title);

	ui_display_text (get_trans ("Select Object To View"), x, y);

	////////////////////////////////////////
	//
	// view
	//
	////////////////////////////////////////

	x = view_menu_x_start * full_screen_width;
	y += y_add;

	set_ui_font_type (VIEW_MENU_FONT);

	y_add = ui_get_font_height ();

	set_ui_font_colour (ext_col_list_title);

	{
		int
			i;

		x += ui_display_text ("View: ", x, y);

		for (i = 0; i < NUM_VIEW_GROUPS; i++)
		{
			if (i == search.group)
			{
				set_ui_font_colour (ext_col_list_item_selected);
			}
			else
			{
				set_ui_font_colour (ext_col_list_item_available);
			}

			x += ui_display_text (group_names[i], x, y);

			x += ui_display_text ("  ", x, y);
		}
	}

	set_ui_font_colour (ext_col_list_item_unavailable);

	ui_display_text ("(Alt+F5 Alt+F6 Alt+F7 Alt+F8)", x, y);

	////////////////////////////////////////
	//
	// range
	//
	////////////////////////////////////////

	x = view_menu_x_start * full_screen_width;
	y += y_add;

	set_ui_font_colour (ext_col_list_title);

	x += ui_display_text ("Range: ", x, y);

	//
	//
	//

	if (search.sqr_range == VIEW_RANGE_5KM)
	{
		set_ui_font_colour (ext_col_list_item_selected);
	}
	else
	{
		set_ui_font_colour (ext_col_list_item_available);
	}

	x += ui_display_text (get_view_range_string (VIEW_RANGE_5KM), x, y);

	x += ui_display_text ("  ", x, y);

	//
	//
	//

	if (search.sqr_range == VIEW_RANGE_10KM)
	{
		set_ui_font_colour (ext_col_list_item_selected);
	}
	else
	{
		set_ui_font_colour (ext_col_list_item_available);
	}

	x += ui_display_text (get_view_range_string (VIEW_RANGE_10KM), x, y);

	x += ui_display_text ("  ", x, y);

	//
	//
	//

	if (search.sqr_range == VIEW_RANGE_50KM)
	{
		set_ui_font_colour (ext_col_list_item_selected);
	}
	else
	{
		set_ui_font_colour (ext_col_list_item_available);
	}

	x += ui_display_text (get_view_range_string (VIEW_RANGE_50KM), x, y);

	x += ui_display_text ("  ", x, y);

	//
	//
	//

	if (search.sqr_range == VIEW_RANGE_100KM)
	{
		set_ui_font_colour (ext_col_list_item_selected);
	}
	else
	{
		set_ui_font_colour (ext_col_list_item_available);
	}

	x += ui_display_text (get_view_range_string (VIEW_RANGE_100KM), x, y);

	x += ui_display_text ("  ", x, y);

	//
	//
	//

	if (search.sqr_range == VIEW_RANGE_ALL)
	{
		set_ui_font_colour (ext_col_list_item_selected);
	}
	else
	{
		set_ui_font_colour (ext_col_list_item_available);
	}

	x += ui_display_text (get_view_range_string (VIEW_RANGE_ALL), x, y);

	x += ui_display_text ("  ", x, y);

	//
	//
	//

	set_ui_font_colour (ext_col_list_item_unavailable);

	ui_display_text ("(Alt+- Alt+=)", x, y);

	////////////////////////////////////////
	//
	// lists
	//
	////////////////////////////////////////

	y_list = y + (y_add * 2.0);

	display_list_length = (int) ((y_max - (y_list + (y_add * 3.0))) / y_add);

	ASSERT (display_list_length > 0);

	////////////////////////////////////////
	//
	// side
	//
	////////////////////////////////////////

	x = view_menu_x_start * full_screen_width;
	y = y_list;

	set_ui_font_colour (ext_col_list_title);

	width = ui_display_text ("Side:", x, y);

	set_ui_font_colour (ext_col_list_item_unavailable);

	ui_display_text (" (Ctrl+F5)", x + width, y);

	y += y_add;

	display_array_list
	(
		side_counters,
		side_names,
		search.side,
		NUM_VIEW_SIDES,
		x,
		y,
		y_add,
		display_list_length
	);

	////////////////////////////////////////
	//
	// category
	//
	////////////////////////////////////////

	x += side_list_width * full_screen_width;
	y = y_list;

	set_ui_font_colour (ext_col_list_title);

	width = ui_display_text ("Category:", x, y);

	set_ui_font_colour (ext_col_list_item_unavailable);

	ui_display_text (" (Ctrl+F6)", x + width, y);

	y += y_add;

	display_array_list
	(
		category_counters,
		category_names,
		search.category,
		NUM_VIEW_CATEGORIES,
		x,
		y,
		y_add,
		display_list_length
	);

	////////////////////////////////////////
	//
	// type
	//
	////////////////////////////////////////

	x += category_list_width * full_screen_width;
	y = y_list;

	set_ui_font_colour (ext_col_list_title);

	width = ui_display_text ("Type:", x, y);

	set_ui_font_colour (ext_col_list_item_unavailable);

	ui_display_text (" (Ctrl+F7)", x + width, y);

	y += y_add;

	display_array_list
	(
		type_counters,
		type_names,
		search.type,
		NUM_VIEW_TYPES,
		x,
		y,
		y_add,
		display_list_length
	);

	////////////////////////////////////////
	//
	// object
	//
	////////////////////////////////////////

	x += type_list_width * full_screen_width;
	y = y_list;

	set_ui_font_colour (ext_col_list_title);

	if (type_counters[search.type] == 1)
	{
		sprintf (s, "Object (1 object):");
	}
	else
	{
		sprintf (s, "Object (%d objects):", type_counters[search.type]);
	}

	width = ui_display_text (s, x, y);

	set_ui_font_colour (ext_col_list_item_unavailable);

	ui_display_text (" (Ctrl+F8)", x + width, y);

	y += y_add;

	display_object_list
	(
		x,
		y,
		y_add,
		type_counters[search.type],
		display_list_length
	);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static float get_view_menu_search_string_width (void)
{
	float
		width;

	char
		s1[200],
		s2[200];

	if (type_counters[search.type] == 1)
	{
		sprintf (s2, "(1 object)");
	}
	else
	{
		sprintf (s2, "(%d objects)", type_counters[search.type]);
	}

	sprintf
	(
		s1,
		"View:%s Range:%s Side:%s Category:%s Type:%s %s",
		group_names[search.group],
		get_view_range_string (search.sqr_range),
		side_names[search.side],
		category_names[search.category],
		type_names[search.type],
		s2
	);

	width = ui_get_string_length (s1);

	return (width);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void display_view_menu_search_string (float x, float y)
{
	char
		s[200];

	float
		width;

	width = get_view_menu_search_string_width ();

	x -= width * 0.5;

	//
	// keep in sync with get_view_menu_search_string_width ()
	//

	set_ui_font_colour (ext_col_list_title);
	x += ui_display_text ("View:", x, y);
	set_ui_font_colour (ext_col_list_item_selected);
	x += ui_display_text (group_names[search.group], x, y);

	set_ui_font_colour (ext_col_list_title);
	x += ui_display_text (" Range:", x, y);
	set_ui_font_colour (ext_col_list_item_selected);
	x += ui_display_text (get_view_range_string (search.sqr_range), x, y);

	set_ui_font_colour (ext_col_list_title);
	x += ui_display_text (" Side:", x, y);
	set_ui_font_colour (ext_col_list_item_selected);
	x += ui_display_text (side_names[search.side], x, y);

	set_ui_font_colour (ext_col_list_title);
	x += ui_display_text (" Category:", x, y);
	set_ui_font_colour (ext_col_list_item_selected);
	x += ui_display_text (category_names[search.category], x, y);

	set_ui_font_colour (ext_col_list_title);
	x += ui_display_text (" Type:", x, y);
	set_ui_font_colour (ext_col_list_item_selected);
	x += ui_display_text (type_names[search.type], x, y);

	if (type_counters[search.type] == 1)
	{
		sprintf (s, " (1 object)");
	}
	else
	{
		sprintf (s, " (%d objects)", type_counters[search.type]);
	}

	set_ui_font_colour (ext_col_list_title);
	ui_display_text (s, x, y);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// ACCESS FUNCTIONS
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_next_side (void)
{
	validate_view_menu ();

	search.side = get_next_valid_array_index (side_counters, search.side, NUM_VIEW_SIDES);

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_previous_side_event (void)
{
	validate_view_menu ();

	search.side = get_previous_valid_array_index (side_counters, search.side, NUM_VIEW_SIDES);

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_next_category (void)
{
	validate_view_menu ();

	search.category = get_next_valid_array_index (category_counters, search.category, NUM_VIEW_CATEGORIES);

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_previous_category (void)
{
	validate_view_menu ();

	search.category = get_previous_valid_array_index (category_counters, search.category, NUM_VIEW_CATEGORIES);

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_next_type (void)
{
	validate_view_menu ();

	search.type = get_next_valid_array_index (type_counters, search.type, NUM_VIEW_TYPES);

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_previous_type (void)
{
	validate_view_menu ();

	search.type = get_previous_valid_array_index (type_counters, search.type, NUM_VIEW_TYPES);

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_next_object (void)
{
	entity
		*en;

	validate_view_menu ();

	en = get_external_view_entity ();

	en = get_next_view_search_match (en);

	set_raw_external_view_entity (en);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_previous_object_event (void)
{
	entity
		*en;

	validate_view_menu ();

	en = get_external_view_entity ();

	en = get_previous_view_search_match (en);

	set_raw_external_view_entity (en);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int select_view_menu_view_players_gunship (void)
{
	entity
		*en;

	validate_view_menu ();

	en = get_gunship_entity ();

	if (en)
	{
		widen_view_search_params (en);

		set_raw_external_view_entity (en);

		return (TRUE);
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int select_view_menu_view_players_target (void)
{
	entity
		*source,
		*target;

	validate_view_menu ();

	source = get_gunship_entity ();

	if (source)
	{
		target = get_local_entity_parent (source, LIST_TYPE_TARGET);

		if (target)
		{
			if (get_local_entity_int_value (target, INT_TYPE_VIEWABLE))
			{
				widen_view_search_params (target);

				set_raw_external_view_entity (target);

				if (get_local_entity_int_value (get_camera_entity (), INT_TYPE_CAMERA_MODE) == CAMERA_MODE_CHASE)
				{
					set_chase_camera_view_target_to_source (source, target);
				}

				return (TRUE);
			}
		}
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int select_view_menu_view_players_padlock (void)
{
	entity
		*source,
		*target;

	validate_view_menu ();

	source = get_gunship_entity ();

	if (source)
	{
		target = get_players_padlock ();

		if (target)
		{
			if (!get_local_entity_int_value (target, INT_TYPE_IDENTIFY_WEAPON))
			{
				if (get_local_entity_int_value (target, INT_TYPE_VIEWABLE))
				{
					widen_view_search_params (target);

					set_raw_external_view_entity (target);

					if (get_local_entity_int_value (get_camera_entity (), INT_TYPE_CAMERA_MODE) == CAMERA_MODE_CHASE)
					{
						set_chase_camera_view_target_to_source (source, target);
					}

					return (TRUE);
				}
				else
				{
					if (get_local_entity_int_value (target, INT_TYPE_IDENTIFY_FIXED))
					{
						notify_local_entity (ENTITY_MESSAGE_SET_CAMERA_ACTION, get_camera_entity (), NULL, CAMERA_ACTION_BUILDING);

						reset_building_camera_values (target);
					}
				}
			}
			else
			{
				if (get_local_entity_int_value (target, INT_TYPE_VIEWABLE_WEAPON))
				{
					entity
						*launcher;

					launcher = get_local_entity_parent (target, LIST_TYPE_LAUNCHED_WEAPON);

					if (launcher)
					{
						if (get_local_entity_int_value (launcher, INT_TYPE_VIEWABLE))
						{
							if (target == get_local_entity_viewable_weapon (launcher))
							{
								widen_view_search_params (launcher);

								set_raw_external_view_entity (launcher);

								return (TRUE);
							}
						}
					}
				}
			}
		}
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_view_all (void)
{
	validate_view_menu ();

	search.group = VIEW_GROUP_ALL;

	search.side = VIEW_SIDE_ALL;

	search.category = VIEW_CATEGORY_ALL;

	search.type = VIEW_TYPE_ALL;

	search.sqr_range = VIEW_RANGE_ALL;

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int select_view_menu_view_wingmen (void)
{
	entity
		*en;

	validate_view_menu ();

	en = get_gunship_entity ();

	if (en)
	{
		search.group = VIEW_GROUP_WINGMEN;

		search.side = VIEW_SIDE_ALL;

		search.category = VIEW_CATEGORY_ALL;

		search.type = VIEW_TYPE_ALL;

		rebuild_view_menu ();

		//
		// if viewing the player's gunship then select the next wingman
		//

		if (en == get_external_view_entity ())
		{
			en = get_next_view_search_match (en);

			set_raw_external_view_entity (en);
		}

		return (TRUE);
	}

	return (FALSE);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_view_players (void)
{
	entity
		*en;

	validate_view_menu ();

	search.group = VIEW_GROUP_PLAYERS;

	search.side = VIEW_SIDE_ALL;

	search.category = VIEW_CATEGORY_ALL;

	search.type = VIEW_TYPE_ALL;

	rebuild_view_menu ();

	//
	// if viewing the player's gunship then select the next player
	//

	en = get_gunship_entity ();

	if (en == get_external_view_entity ())
	{
		en = get_next_view_search_match (en);

		set_raw_external_view_entity (en);
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_view_menu_view_available_gunships (void)
{
	validate_view_menu ();

	search.group = VIEW_GROUP_AVAILABLE_GUNSHIPS;

	search.side = VIEW_SIDE_ALL;

	search.category = VIEW_CATEGORY_ALL;

	search.type = VIEW_TYPE_ALL;

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_next_view_menu_range (void)
{
	validate_view_menu ();

	if (search.sqr_range == VIEW_RANGE_5KM)
	{
		search.sqr_range = VIEW_RANGE_10KM;
	}
	else if (search.sqr_range == VIEW_RANGE_10KM)
	{
		search.sqr_range = VIEW_RANGE_50KM;
	}
	else if (search.sqr_range == VIEW_RANGE_50KM)
	{
		search.sqr_range = VIEW_RANGE_100KM;
	}
	else if (search.sqr_range == VIEW_RANGE_100KM)
	{
		search.sqr_range = VIEW_RANGE_ALL;
	}

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void select_previous_view_menu_range (void)
{
	validate_view_menu ();

	if (search.sqr_range == VIEW_RANGE_ALL)
	{
		search.sqr_range = VIEW_RANGE_100KM;
	}
	else if (search.sqr_range == VIEW_RANGE_100KM)
	{
		search.sqr_range = VIEW_RANGE_50KM;
	}
	else if (search.sqr_range == VIEW_RANGE_50KM)
	{
		search.sqr_range = VIEW_RANGE_10KM;
	}
	else if (search.sqr_range == VIEW_RANGE_10KM)
	{
		search.sqr_range = VIEW_RANGE_5KM;
	}

	rebuild_view_menu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_view_menu_display_visible_status (int status)
{
	ASSERT (initialised);

	validate_view_menu ();

	display_enabled = status;

	if (display_enabled)
	{
		rebuild_view_menu ();
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int get_view_menu_display_visible_status (void)
{
	return (display_enabled);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void notify_view_menu_of_view_list_change (entity *en)
{
	if (get_game_status () == GAME_STATUS_INITIALISED)
	{
		validate_view_menu ();

		entity_being_destroyed = en;

		rebuild_view_menu ();

		entity_being_destroyed = NULL;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_view_menu_to_match_external_view_entity (void)
{
	entity
		*en;

	if (initialised)
	{
		validate_view_menu ();

		en = get_external_view_entity ();

		ASSERT (en);

		widen_view_search_params (en);
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int get_entity_available_from_view_menu (entity *en)
{
	ASSERT (en);

	return (get_match_view_search (en));
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
