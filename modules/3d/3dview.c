// 
// 	 Enemy Engaged RAH-66 Comanche Versus KA-52 Hokum
// 	 Copyright (C) 2000 Empire Interactive (Europe) Ltd,
// 	 677 High Road, North Finchley, London N12 0DA
// 
// 	 Please see the document LICENSE.TXT for the full licence agreement
// 
// 2. LICENCE
//  2.1 	
//  	Subject to the provisions of this Agreement we now grant to you the 
//  	following rights in respect of the Source Code:
//   2.1.1 
//   	the non-exclusive right to Exploit  the Source Code and Executable 
//   	Code on any medium; and 
//   2.1.2 
//   	the non-exclusive right to create and distribute Derivative Works.
//  2.2 	
//  	Subject to the provisions of this Agreement we now grant you the
// 	following rights in respect of the Object Code:
//   2.2.1 
// 	the non-exclusive right to Exploit the Object Code on the same
// 	terms and conditions set out in clause 3, provided that any
// 	distribution is done so on the terms of this Agreement and is
// 	accompanied by the Source Code and Executable Code (as
// 	applicable).
// 
// 3. GENERAL OBLIGATIONS
//  3.1 
//  	In consideration of the licence granted in clause 2.1 you now agree:
//   3.1.1 
// 	that when you distribute the Source Code or Executable Code or
// 	any Derivative Works to Recipients you will also include the
// 	terms of this Agreement;
//   3.1.2 
// 	that when you make the Source Code, Executable Code or any
// 	Derivative Works ("Materials") available to download, you will
// 	ensure that Recipients must accept the terms of this Agreement
// 	before being allowed to download such Materials;
//   3.1.3 
// 	that by Exploiting the Source Code or Executable Code you may
// 	not impose any further restrictions on a Recipient's subsequent
// 	Exploitation of the Source Code or Executable Code other than
// 	those contained in the terms and conditions of this Agreement;
//   3.1.4 
// 	not (and not to allow any third party) to profit or make any
// 	charge for the Source Code, or Executable Code, any
// 	Exploitation of the Source Code or Executable Code, or for any
// 	Derivative Works;
//   3.1.5 
// 	not to place any restrictions on the operability of the Source 
// 	Code;
//   3.1.6 
// 	to attach prominent notices to any Derivative Works stating
// 	that you have changed the Source Code or Executable Code and to
// 	include the details anddate of such change; and
//   3.1.7 
//   	not to Exploit the Source Code or Executable Code otherwise than
// 	as expressly permitted by  this Agreement.
// 



/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "3d.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

env_3d
	*active_3d_environment = NULL;

viewpoint
	*visual_3d_vp;

float
	current_3d_viewangle_distance_conversion_factor;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_viewpoint ( env_3d *env, viewpoint *vp )
{

	ASSERT ( env );
	ASSERT ( vp );

	env->view = vp;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_viewport ( env_3d *env, float xmin, float ymin, float xmax, float ymax )
{

	ASSERT ( env );
	ASSERT ( xmin <= xmax );
	ASSERT ( ymin <= ymax );

	env->clip_xmin = xmin;
	env->clip_ymin = ymin;
	env->clip_xmax = xmax;
	env->clip_ymax = ymax;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_view_distances ( env_3d *env, float yonder, float hither, float zbuffer_zmin, float zbuffer_zmax )
{

	ASSERT ( env );

	env->yonder_distance = yonder;
	env->hither_distance = hither;

	env->zbuffer_z_minimum_value = zbuffer_zmin;
	env->zbuffer_z_maximum_value = zbuffer_zmax;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_origin ( env_3d *env, float xorigin, float yorigin )
{

	ASSERT ( env );

	env->x_origin = xorigin;

	env->y_origin = yorigin;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_viewcone (  env_3d *env, float width, float height, float width_view_angle, float height_view_angle )
{

	float
		tan_width_angle,
		tan_height_angle;

	ASSERT ( env );

	//
	// viewangle must never be PI/2 or above, as it is impossible to occur in nature
	//

	tan_width_angle = tan ( width_view_angle / 2.0 );

	tan_height_angle = tan ( height_view_angle / 2.0 );

	env->screen_i_scale = ( width / ( 2.0 * tan_width_angle ) );

	env->screen_j_scale = ( height / ( 2.0 * tan_height_angle ) );

	env->width_view_angle = width_view_angle;

	env->height_view_angle = height_view_angle;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_lightmode ( env_3d *env, enum LIGHTMODES mode )
{

	ASSERT ( env );

	switch ( mode )
	{

		case LIGHTMODE_NO_LIGHT:
		case LIGHTMODE_AUTOMATIC_LIGHT:
		case LIGHTMODE_MANUAL_LIGHT:
		{

			break;
		}

		default:
		{

			debug_fatal ( "Trying to set an unknown light mode for 3d environment" );

			break;
		}
	}

	env->lightmode = mode;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_fogmode ( env_3d *env, fogmodes mode )
{

	ASSERT ( env );

	env->fogmode = mode;

	switch ( mode )
	{

		case FOGMODE_ON_AUTOMATIC:
		case FOGMODE_ON_MANUAL:
		case FOGMODE_OFF:
		{
		
			break;
		}

		default:
		{

			debug_fatal ( "Unknown fogmode in set_3d_fogmode" );

			break;
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_3d_fog_distances ( env_3d *env, float fog_start, float fog_end )
{

	ASSERT ( env );

	env->fog_start = fog_start;

	env->fog_end = fog_end;

	switch ( env->fogmode )
	{

		case FOGMODE_ON_AUTOMATIC:
		case FOGMODE_ON_MANUAL:
		{
		
			ASSERT ( fog_start < fog_end );
		
			break;
		}

		case FOGMODE_OFF:
		{

			break;
		}

		default:
		{

			debug_fatal ( "Unknown fogmode" );

			break;
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

viewpoint *get_3d_viewpoint ( env_3d *env )
{

	ASSERT ( env );

	return ( env->view );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void get_3d_viewport ( env_3d *env, float *xmin, float *ymin, float *xmax, float *ymax )
{

	ASSERT ( env );

	*xmin = env->clip_xmin;
	*ymin = env->clip_ymin;
	*xmax = env->clip_xmax;
	*ymax = env->clip_ymax;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void get_3d_view_distances ( env_3d *env, float *yonder, float *hither )
{

	ASSERT ( env );

	*yonder = env->yonder_distance;
	*hither = env->hither_distance;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void get_3d_origin ( env_3d *env, float *xorigin, float *yorigin )
{

	ASSERT ( env );

	*xorigin = env->x_origin;
	*yorigin = env->y_origin;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

enum LIGHTMODES get_3d_lightmode ( env_3d *env )
{

	ASSERT ( env );

	return ( env->lightmode );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

fogmodes get_3d_fogmode ( env_3d *env )
{

	ASSERT ( env );

	return ( env->fogmode );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void get_3d_fog_distances ( env_3d *env, float *fog_start, float *fog_end )
{

	ASSERT ( env );

	*fog_start = env->fog_start;

	*fog_end = env->fog_end;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void realise_3d_clip_extents ( env_3d *env )
{

	ASSERT ( env );

	set_3d_clip_extents ( env->yonder_distance, env->hither_distance,
									env->clip_xmin, env->clip_ymin,
									env->clip_xmax, env->clip_ymax,
									env->zbuffer_z_minimum_value,
									env->zbuffer_z_maximum_value );

	//
	// Also set the viewcone stuff here
	//

	current_3d_viewangle_distance_conversion_factor = tan ( env->width_view_angle ) / tan ( rad ( 59.99 ) );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void realise_3d_lightmode ( env_3d *env )
{

	ASSERT ( env );

	//
	// Remove all lights from the scene
	//

	reset_light_3d_sources_in_3d_scene ();

	//
	// Set the ambient light level
	//

	set_3d_ambient_light_level ( env->ambient_light.red, env->ambient_light.green, env->ambient_light.blue );

	//
	// Now put in the main lights ( sun, moon, or main_3d_light )
	//

	setup_environment_lights_in_scene ( env );

	shadows_enabled = env->shadows_enabled;

	shadows_strength = env->shadow_strength;

	if ( shadows_strength < 0.004 )
	{

		shadows_enabled = FALSE;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void realise_3d_viewpoint ( env_3d *env )
{

	ASSERT ( env );

	visual_3d_vp = env->view;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void realise_3d_fogmode ( env_3d *env )
{

	ASSERT ( env );

	if ( ( env->fogmode == FOGMODE_ON_AUTOMATIC ) || ( env->fogmode == FOGMODE_ON_MANUAL ) )
	{

		set_d3d_fog_parameters ( TRUE, env->fog_colour, env->fog_start, env->fog_end );

		if ( env->yonder_distance > env->fog_end )
		{
	
			env->yonder_distance = env->fog_end;
		}
	}
	else
	{

		set_d3d_fog_parameters ( FALSE, env->fog_colour, env->fog_start, env->fog_end );
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void realise_3d_shadow_setting ( env_3d *env )
{

	ASSERT ( env );

	set_d3d_shadow_colour ( env->shadow_setting.light_colour.red * 255.0,
									env->shadow_setting.light_colour.green * 255.0,
									env->shadow_setting.light_colour.blue * 255.0,
									128.0 );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int get_3d_point_2d_outcode ( float x, float y, float z )
{

	double
		cos_width,
		sin_width,
		cos_height,
		sin_height,
		left_clip,
		right_clip,
		top_clip,
		bottom_clip;

	int
		outcode;

	cos_width = cos ( active_3d_environment->width_view_angle );
	sin_width = sin ( active_3d_environment->width_view_angle );

	cos_height = cos ( active_3d_environment->height_view_angle );
	sin_height = sin ( active_3d_environment->height_view_angle );

	left_clip = cos_width * x + sin_width * z;
	right_clip = -cos_width * x + sin_width * z;

	top_clip = -cos_height * y + sin_height * z;
	bottom_clip = cos_height * y + sin_height * z;

	outcode = 0;

	if ( left_clip < -10.1 )
	{

		outcode |= CLIP_LEFT;
	}

	if ( right_clip < -10.1 )
	{

		outcode |= CLIP_RIGHT;
	}

	if ( top_clip < -10.1 )
	{

		outcode |= CLIP_TOP;
	}

	if ( bottom_clip < -10.1 )
	{

		outcode |= CLIP_BOTTOM;
	}

	return ( outcode );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

